import pandas as pd
from PIL import Image


def get_image_dimensions(image_path):
    with Image.open(image_path) as img:
        return img.size  # (width, height)


def create_bigcontainer_css():
    return """
.container {
  display: grid;
  grid-template-rows: repeat(60, 1fr);
  grid-template-columns: repeat(60, 1fr);
  gap: 1px;
  width: 100vw;
  height: 100vh;
  max-width: 100vw;
  max-height: 100vh;
  border: 1px solid black;
  box-sizing: border-box;
}
"""


def create_container(image_path, datacsv):
    # Image dimensions kept in case you need scaling later
    width, height = get_image_dimensions(image_path)

    data = pd.read_csv(datacsv)
    data = data.sort_values(by=["Grid Row Start", "Grid Col Start"])

    html_output = []
    css_output = []

    for i, row in data.iterrows():
        element = row["Class"]
        element_id = f"{element}{i}"

        grid_row_start = row["Grid Row Start"] + 1
        grid_row_end = row["Grid Row End"] + 1
        grid_col_start = row["Grid Col Start"] + 1
        grid_col_end = row["Grid Col End"] + 1

        html_output.append(
            f'<div class="item {element_id}">{element_id}</div>'
        )

        css_output.append(
            f"""
.{element_id} {{
  background-color: lightblue;
  grid-row: {grid_row_start} / {grid_row_end};
  grid-column: {grid_col_start} / {grid_col_end};
  border: 2px solid red;
  color: red;
}}
"""
        )

    return "\n".join(html_output), "\n".join(css_output)


def insert_div_at_top_of_body(html_path, html_output):
    with open(html_path, "r", encoding="utf-8") as file:
        html_content = file.read()

    body_index = html_content.lower().find("<body>")
    if body_index == -1:
        raise ValueError("The HTML file does not contain a <body> tag")

    insertion_point = body_index + len("<body>")
    container_div = f"\n<div class=\"container\">\n{html_output}\n</div>\n"

    updated_html = (
        html_content[:insertion_point]
        + container_div
        + html_content[insertion_point:]
    )

    with open(html_path, "w", encoding="utf-8") as file:
        file.write(updated_html)

    print(f"Inserted container into {html_path}")


def main(image_path, datacsv, html_path):
    big_container_css = create_bigcontainer_css()
    html_output, elements_css = create_container(image_path, datacsv)

    with open("style.css", "w", encoding="utf-8") as css_file:
        css_file.write(big_container_css + "\n" + elements_css)

    insert_div_at_top_of_body(html_path, html_output)


# --------- RUN ----------
image_path = "/content/test_image.png"
datacsv = "/content/Screenshot_positions.csv"
html_path = "/content/page2.html"

main(image_path, datacsv, html_path)
